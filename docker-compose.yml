services:
  fabric:
    build:
      context: .
      dockerfile: Dockerfile
    image: neosun/fabric:latest
    container_name: fabric
    restart: unless-stopped
    ports:
      - "0.0.0.0:${WEB_PORT:-8080}:8080"   # Web UI
      - "0.0.0.0:${PORT:-8180}:8180"       # REST API + Swagger UI
      - "0.0.0.0:${MCP_PORT:-8181}:8181"   # MCP Server
    environment:
      - PORT=8180
      - MCP_PORT=8181
      - WEB_PORT=8080
      - API_KEY=${API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - OLLAMA_HOST=${OLLAMA_HOST:-}
      - DEFAULT_MODEL=${DEFAULT_MODEL:-gpt-4o}
      - DEFAULT_VENDOR=${DEFAULT_VENDOR:-openai}
      - TZ=${TZ:-Asia/Shanghai}
    volumes:
      - fabric-config:/root/.config/fabric
      - /tmp/fabric:/tmp/fabric
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8180/patterns/names"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  fabric-config:
